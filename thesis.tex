\documentclass[12pt,draft]{reedthesis}

% Core packages
\usepackage[fleqn]{mathtools} % Load before newtxmath
\mathtoolsset{%
  mathic,
}
% \setlength{\mathindent}{0pt}
\allowdisplaybreaks%

\usepackage[%
math-style=ISO,
bold-style=ISO,
sans-style=italic,
nabla=upright,
partial=upright,
]{unicode-math}
% \let\symsf\mathsf%
% \let\symbf\mathbf%
% \let\symsfup\mathbf%

\usepackage[numbers]{natbib}

\usepackage{ifdraft} % final: for printing (set bw, etc.)
\usepackage{xstring}
\usepackage{subfiles}
\newcommand{\notebook}[1]{\subfile{../notebooks/tex/#1}}


\AtEndDocument{%
  \bibliographystyle{unsrtnat}
  \bibliography{thesis}
  \printindex
}

% Layout and styling
\usepackage{etoolbox}
\usepackage[final]{microtype}
% \usepackage{setspace} 
% \onehalfspacing%
\usepackage{booktabs}
\usepackage{enumitem}
\usepackage{rotating}
\usepackage{fnpct}
\setlist[enumerate,1]{label=\textbf{\arabic*.}}

\usepackage[labelfont=bf]{caption}

\usepackage{sectsty}
\allsectionsfont{%
  \normalfont\liningnums%
}
\sectionfont{%
  \normalfont\itshape\liningnums%
}
\subsectionfont{%
  \normalfont\itshape\liningnums%
}
\subsubsectionfont{%
  \normalfont\itshape\liningnums%
}

\usepackage{todonotes}

\IfEq{\jobname}{\detokenize{thesis}}{% Full document
  \usepackage[titles]{tocloft}
  }{% In a subfile
  \usepackage{tocloft}
}

\usepackage{amsthm}
\renewcommand*{\proofname}{\normalfont\textbf{Proof}}
\theoremstyle{plain}
\newtheorem{thm}{Theorem}[section]
\newtheorem{lem}{Lemma}
\theoremstyle{definition}
\newtheorem{defn}{Definition}
\newtheorem{rmk}{Remark}
\newtheorem{ex}{Example}
\newtheorem{post}{Postulate}

% Fonts
\usepackage[full]{textcomp} % to get the right copyright, etc.
\usepackage{libertinus-otf}
\usepackage[scaled=.95,type1]{cabin} % sans serif in style of Gill Sans
% \usepackage[varqu,varl]{zi4}% inconsolata typewriter
\usepackage[T1]{fontenc} % LY1 also works
\setmainfont[Numbers={OldStyle,Proportional}]{fbb}
\usepackage[supstfm=fbb-Regular-sup-t1]{superiors}
% \setmonofont[Scale=MatchLowercase]{DejaVu Sans Mono}
% \setmonofont[Scale=MatchLowercase]{Iosevka} % We need unicode
\setmonofont[Scale=MatchLowercase]{JuliaMono} % We need unicode
\usepackage[cal=boondoxo,bb=boondox,frak=boondox]{mathalfa}

% 1.5 / 1.208, where 1.208 is the default baseline skip to font size ratio.
% That is, for 12pt font, the default baseline skip is 14.5pt
% https://www.tug.org/svn/texlive/trunk/Master/texmf-dist/tex/latex/base/size12.clo?view=co
\linespread{1.24137}

% \restoresymbol{TXV}{arrowvert}

\usepackage{lettrine}
% \usepackage{Zallman} % Even fancier
% \renewcommand\LettrineFontHook{\Zallmanfamily}
% \newcommand{\dropcap}[2]{\lettrine{#1}{#2}}
\newcommand{\dropcap}[2]{\textsc{#1#2}}

\ifdraft{\overfullrule=1mm}{}

\usepackage{parskip}
% \setlength{\parskip}{0pt}

\usepackage{imakeidx}
\makeindex
\newcommand{\term}[1]{\index{#1}\textbf{#1}}
\newcommand{\termalt}[2]{\index{#1}\textbf{#2}}


\usepackage[switch*,pagewise]{lineno} % Before minted
% \ifdraft{\linenumbers}{}

% Patch amsmath environments to work with lineno
\newcommand*\patchAmsMathEnvironmentForLineno[1]{%
  \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
  \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
  \renewenvironment{#1}%
  {\linenomath\csname old#1\endcsname}%
{\csname oldend#1\endcsname\endlinenomath}}%
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{%
  \patchAmsMathEnvironmentForLineno{#1}%
\patchAmsMathEnvironmentForLineno{#1*}}%
\AtBeginDocument{%
  \patchBothAmsMathEnvironmentsForLineno{equation}%
  \patchBothAmsMathEnvironmentsForLineno{align}%
  \patchBothAmsMathEnvironmentsForLineno{flalign}%
  \patchBothAmsMathEnvironmentsForLineno{alignat}%
  \patchBothAmsMathEnvironmentsForLineno{gather}%
  \patchBothAmsMathEnvironmentsForLineno{multline}%
}

% Code highlighting
\usepackage{textcomp}
% \usepackage{upquote}
\usepackage[final]{minted}
\setminted{%
  % mathescape,
  breaklines,
  fontsize=\small,
}
\setminted[wolfram]{style=mathematica}
\ifoptionfinal{\setminted{style=bw}}{\setminted{style=friendly}}

% Graphics
\PassOptionsToPackage{final}{graphicx}
\def\figwidth{\linewidth}
\usepackage{graphicx}
\setkeys{Gin}{draft=false}
% \usepackage{float}
% \usepackage{tikz}

\graphicspath{{figs/}{notebooks/tex/}}

% Other
% \usepackage{kantlipsum}
% \ifdraft{\usepackage{draftwatermark}\SetWatermarkColor[gray]{0.975}}{}

% More preamble commands, separated for reuse by notebooks
\input{preamble/math-packages}
\input{preamble/math-commands}
\input{preamble/ansi-colors}

% Reference management (order-sensitive)
\usepackage{xparse}
\usepackage[pdfusetitle,final,backref]{hyperref}
\usepackage[all]{hypcap}
\usepackage{cleveref}

% \usepackage[nameinlink]{cleveref}

% \newcommand{\rubricmark}[1]{\hspace*{-0.1em}\textsuperscript{\textcolor{rubric}{#1}}}
% \AdaptNoteNoOptNoMult{\rubricmark}

% \usepackage{letltxmacro}
% \LetLtxMacro\oldcref\cref%
% \RenewDocumentCommand{\cref}{m}{{\oldcref{#1}}\rubricmark{$\circ$}}
% \LetLtxMacro\oldCref\Cref%
% \RenewDocumentCommand{\Cref}{m}{{\oldCref{#1}}\rubricmark{$\circ$}}

\IfEq{\jobname}{\detokenize{thesis}}{% Full document
  % Nothing different
  }{% In a subfile
  % Looks like this must be after hyperref is loaded for \url to work.
  \AtBeginDocument{%
    \ifdraft{%
      {%
        \setlength{\parindent}{0pt}
        \setlength{\parskip}{\baselineskip}

        {\LARGE
          \textsf{Document information}
        }

        Alex Striff \\ \@date

        \input{HEAD.out}

        {\small
          \let\clearpage\relax
          \renewcommand{\cfttoctitlefont}{\Large\normalfont\liningnums}
          \setlength{\cftbeforetoctitleskip}{0.5\baselineskip}
          \setlength{\cftaftertoctitleskip}{0pt}
          \renewcommand{\cftchapafterpnum}{}
          \tableofcontents
        }
      }
      }{}
    }
}

\crefname{thm}{theorem}{theorems}
\crefname{lem}{lemma}{lemmas}
\crefname{defn}{definition}{definitions}
\crefname{post}{postulate}{postulates}

\ifdraft{}{\usepackage{autonum}}

\definecolor{linkcolor}{rgb}{0.0,0.25,0.5}
\definecolor{rubric}{rgb}{0.7,0.05,0.0}
% \definecolor{screentext}{rgb}{0.075,0.075,0.075} % For easier reading on a backlit screen.
\hypersetup{%
  allcolors=rubric,
}
\urlstyle{same}
\ifoptionfinal{\hypersetup{hidelinks}}{\hypersetup{colorlinks}}

\title{\textbf{\large
    Toy Systems and Quantum Master Equations
  }\ifdraft{\\\textsc{(Provisional Title) \\ \textbf{Draft}}}{}
  }
\author{Alex Striff}
% The month and year that you submit your final draft to the library
% (May or December)
\date{\ifoptionfinal{May 2021}{\today}}
\division{Mathematics and Natural Sciences}
\advisor{Darrell Schroeter}
\department{Physics}

\begin{document}
% \ifoptionfinal{}{\color{screentext}}
\maketitle
\pagenumbering{roman}
\frontmatter
\pagenumbering{arabic}
\pagestyle{empty}

\include{acknowledgements}
% \chapter*{Preface} % Optional
\include{abstract}
% \chapter*{Dedication} % Optional

\mainmatter%
\pagestyle{fancyplain}
{%
  \hypersetup{linkcolor=black}
  \tableofcontents
  \listoffigures
  \listoftables
}

% \ifdraft{\setstretch{1.5}}{}

\include{introduction}
\input{chapters/subfiles.txt}
\include{conclusion}

\appendix
\subfile{appendices/computer-details}

\backmatter% Adds index and bibliography to TOC

% Bibliography added by \AtEndDocument in preamble so that subfiles have
% bibliographies.

\end{document}

